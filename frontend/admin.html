<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>相机数据管理面板</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "微软雅黑"; }
        body { background: #f5f5f5; padding: 20px; }
        .login-box { width: 400px; margin: 100px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: #e4393c; }
        .form-item { margin: 15px 0; display: flex; align-items: flex-start; } /* 仅修改align-items为flex-start适配文本域 */
        .form-item label { width: 80px; padding-top: 8px; } /* 新增padding-top对齐文本域 */
        .form-item input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .form-item textarea { /* 新增文本域样式，和原有输入框保持一致 */
            flex: 1; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            min-height: 120px;
            resize: vertical;
        }
        .btn { padding: 8px 16px; background: #e4393c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; }
        .btn:hover { background: #d02828; }
        .msg { text-align: center; margin-top: 10px; color: red; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logout-btn { padding: 8px 20px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .form-panel, .table-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-panel h3, .table-panel h3 { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .form-panel .form-item label { width: 120px; }
        .form-panel .form-item input, .form-panel .form-item select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f9f9f9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 500px; }
        .modal-btn-group { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <!-- ① 登录模块 -->
    <div class="login-box" id="loginBox">
        <h2>管理员登录</h2>
        <div class="form-item"><label>账号：</label><input type="text" id="username" placeholder=""></div>
        <div class="form-item"><label>密码：</label><input type="password" id="password" placeholder=""></div>
        <button class="btn" onclick="login()">登录</button>
        <p class="msg" id="loginMsg"></p>
    </div>

    <!-- ② 管理面板（登录成功后再显示） -->
    <div class="admin-panel" id="adminPanel" style="display:none;">
        <div class="panel-header">
            <h2>相机数据管理</h2>
            <button class="logout-btn" onclick="logout()">退出登录</button>
        </div>

        <!-- 添加数据 -->
        <div class="form-panel">
            <h3>添加相机数据</h3>
            <div class="form-item"><label>品牌：</label><select id="addBrand"><option value="佳能">佳能</option><option value="尼康">尼康</option><option value="索尼">索尼</option><option value="富士">富士</option></select></div>
            <div class="form-item"><label>型号：</label><input type="text" id="addModel" placeholder="例如：R100"></div>
            <div class="form-item"><label>最低价格：</label><input type="number" id="addMinPrice" placeholder="5000"></div>
            <div class="form-item"><label>最高价格：</label><input type="number" id="addMaxPrice" placeholder="8000"></div>
            <div class="form-item"><label>平均价格：</label><input type="number" id="addAvgPrice" placeholder="6500"></div>
            <!-- 新增：简介输入框（格式和原有保持一致） -->
            <div class="form-item"><label>相机简介：</label><textarea id="addDescription" placeholder="输入相机详细参数和描述..."></textarea></div>
            <div class="form-item"><label>京东价格：</label><input type="text" id="addJdPrices" placeholder="多个价格用逗号分隔"></div>
            <div class="form-item"><label>闲鱼价格：</label><input type="text" id="addXianyuPrices" placeholder="多个价格用逗号分隔"></div>
            <div class="form-item"><label>爬取时间：</label><input type="datetime-local" id="addCrawlTime"></div>
            <button class="btn" onclick="addCamera()">添加数据</button>
        </div>

        <!-- 数据列表 -->
        <div class="table-panel">
            <h3>相机数据列表</h3>
            <table>
                <thead><tr><th>ID</th><th>品牌</th><th>型号</th><th>最低价格</th><th>最高价格</th><th>操作</th></tr></thead>
                <tbody id="cameraTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- 编辑弹窗 -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>编辑相机数据</h3>
            <input type="hidden" id="editId">
            <div class="form-item"><label>品牌：</label><select id="editBrand"><option value="佳能">佳能</option><option value="尼康">尼康</option><option value="索尼">索尼</option><option value="富士">富士</option></select></div>
            <div class="form-item"><label>型号：</label><input type="text" id="editModel"></div>
            <div class="form-item"><label>最低价格：</label><input type="number" id="editMinPrice"></div>
            <div class="form-item"><label>最高价格：</label><input type="number" id="editMaxPrice"></div>
            <div class="form-item"><label>平均价格：</label><input type="number" id="editAvgPrice"></div>
            <!-- 新增：简介输入框（格式和原有保持一致） -->
            <div class="form-item"><label>相机简介：</label><textarea id="editDescription" placeholder="输入相机详细参数和描述..."></textarea></div>
            <div class="form-item"><label>京东价格：</label><input type="text" id="editJdPrices" placeholder="多个价格用逗号分隔"></div>
            <div class="form-item"><label>闲鱼价格：</label><input type="text" id="editXianyuPrices" placeholder="多个价格用逗号分隔"></div>
            <div class="form-item"><label>爬取时间：</label><input type="datetime-local" id="editCrawlTime"></div>
            <div class="modal-btn-group">
                <button class="btn" onclick="saveEdit()">保存修改</button>
                <button class="btn" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>

    <script>
        const baseUrl = 'http://127.0.0.1:5000/api';

        /* ========== 登录 ========== */
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const msg = document.getElementById('loginMsg');
            if (!username || !password) return msg.innerText = '账号和密码不能为空';
            fetch(`${baseUrl}/admin/login`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 0) {
                        msg.innerText = '';
                        document.getElementById('loginBox').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        loadCameraList();
                    } else {
                        msg.innerText = res.message;
                    }
                })
                .catch(e => { msg.innerText = '网络错误：' + e; });
        }

        /* ========== 退出 ========== */
        function logout() {
            fetch(`${baseUrl}/admin/logout`, { method: 'POST', credentials: 'include' })
                .then(() => location.href = '/');
        }

        /* ========== 加载列表 ========== */
        function loadCameraList() {
            fetch(`${baseUrl}/camera/all`, { credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    const tb = document.getElementById('cameraTableBody');
                    tb.innerHTML = '';
                    data.data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${item.id}</td>
                            <td>${item.brand}</td>
                            <td>${item.camera_model}</td>
                            <td>${item.min_price}</td>
                            <td>${item.max_price}</td>
                            <td>
                                <button class="btn" onclick="openEditModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">编辑</button>
                                <button class="btn" onclick="deleteCamera(${item.id}, '${item.brand}')" style="background:#f56c6c">删除</button>
                            </td>`;
                        tb.appendChild(tr);
                    });
                });
        }

        /* ========== 添加 ========== */
        function addCamera() {
            const brand = document.getElementById('addBrand').value;
            const camera_model = document.getElementById('addModel').value.trim();
            const min_price = document.getElementById('addMinPrice').value;
            const max_price = document.getElementById('addMaxPrice').value;
            const avg_price = document.getElementById('addAvgPrice').value;
            // 新增：获取简介值
            const description = document.getElementById('addDescription').value.trim();
            const jd_prices = document.getElementById('addJdPrices').value.split(',').map(Number);
            const xianyu_prices = document.getElementById('addXianyuPrices').value.split(',').map(Number);
            const crawl_time = document.getElementById('addCrawlTime').value;
            if (!camera_model || !min_price || !max_price) return alert('型号、价格必填');
            fetch(`${baseUrl}/camera/add`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    brand, camera_model, min_price, max_price, avg_price, 
                    description, // 新增：传递简介
                    jd_prices, xianyu_prices, crawl_time 
                })
            })
                .then(r => r.json())
                .then(res => { 
                    alert(res.message); 
                    if (res.code === 0) { 
                        clearAddForm(); 
                        loadCameraList(); 
                    } 
                });
        }
        function clearAddForm() {
            // 新增：清空简介输入框
            document.getElementById('addDescription').value = '';
            ['addModel', 'addMinPrice', 'addMaxPrice', 'addAvgPrice', 'addJdPrices', 'addXianyuPrices', 'addCrawlTime'].forEach(id => document.getElementById(id).value = '');
        }

        /* ========== 编辑弹窗 ========== */
        function openEditModal(item) {
            document.getElementById('editId').value = item.id;
            document.getElementById('editBrand').value = item.brand;
            document.getElementById('editModel').value = item.camera_model;
            document.getElementById('editMinPrice').value = item.min_price;
            document.getElementById('editMaxPrice').value = item.max_price;
            document.getElementById('editAvgPrice').value = item.avg_price;
            // 新增：填充简介
            document.getElementById('editDescription').value = item.description || '';
            document.getElementById('editJdPrices').value = item.jd_prices.join(',');
            document.getElementById('editXianyuPrices').value = item.xianyu_prices.join(',');
            if (item.crawl_time) {
                const t = new Date(item.crawl_time);
                document.getElementById('editCrawlTime').value = t.toISOString().slice(0, 16);
            }
            document.getElementById('editModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('editModal').style.display = 'none'; }

        /* ========== 保存编辑 ========== */
        function saveEdit() {
            const id = document.getElementById('editId').value;
            const brand = document.getElementById('editBrand').value;
            const camera_model = document.getElementById('editModel').value.trim();
            const min_price = document.getElementById('editMinPrice').value;
            const max_price = document.getElementById('editMaxPrice').value;
            const avg_price = document.getElementById('editAvgPrice').value;
            // 新增：获取简介值
            const description = document.getElementById('editDescription').value.trim();
            const jd_prices = document.getElementById('editJdPrices').value.split(',').map(Number);
            const xianyu_prices = document.getElementById('editXianyuPrices').value.split(',').map(Number);
            const crawl_time = document.getElementById('editCrawlTime').value;
            if (!id || !camera_model || !min_price || !max_price) return alert('ID、型号、价格必填');
            fetch(`${baseUrl}/camera/edit`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id, brand, camera_model, min_price, max_price, avg_price, 
                    description, // 新增：传递简介
                    jd_prices, xianyu_prices, crawl_time 
                })
            })
                .then(r => r.json())
                .then(res => { 
                    alert(res.message); 
                    if (res.code === 0) { 
                        closeModal(); 
                        loadCameraList(); 
                    } 
                });
        }

        /* ========== 删除 ========== */
        function deleteCamera(id, brand) {
            if (!confirm('确定删除？删除后无法恢复！')) return;
            fetch(`${baseUrl}/camera/delete`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, brand })
            })
                .then(r => r.json())
                .then(res => { alert(res.message); if (res.code === 0) loadCameraList(); });
        }

        /* ========== 页面加载完成后拉数据 ========== */
        window.onload = () => loadCameraList();
    </script>
</body>
</html>